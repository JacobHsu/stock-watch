<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="page-title">Stock Technical Analysis</title>
    <link rel="icon" type="image/png" id="favicon" href="../icons/default.png">
    <link rel="stylesheet" href="../styles.css" />

    <!-- è¼‰å…¥è‚¡ç¥¨è³‡æ–™åº« -->
    <script src="../stock-database.js"></script>

    <script>
      // stockDatabase å·²å¾ stock-database.js è¼‰å…¥

      // ========== æ ¸å¿ƒå‡½æ•¸ ==========
      function getSymbolFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('symbol')?.toUpperCase() || null;
      }

      function getStockInfo(symbol) {
        return stockDatabase[symbol] || {
          exchange: 'NASDAQ',
          name: `${symbol} Corporation`
        };
      }

      // ========== åœ¨ HTML è¼‰å…¥å‰å…ˆå–å¾—è‚¡ç¥¨ä»£ç¢¼ä¸¦ç”Ÿæˆ HTML ==========
      const SYMBOL = getSymbolFromUrl();
      const SYMBOL_LOWER = SYMBOL ? SYMBOL.toLowerCase() : '';
      const STOCK_INFO = SYMBOL ? getStockInfo(SYMBOL) : null;

      console.log('ğŸ¯ å‹•æ…‹è¼‰å…¥è‚¡ç¥¨:', SYMBOL, STOCK_INFO);

      // è¼‰å…¥è¶…æ™‚æª¢æŸ¥
      let tvTimeout = setTimeout(() => {
        if (typeof TradingView === "undefined") {
          document.querySelectorAll('[id^="tradingview_"]').forEach((el) => {
            el.innerHTML = '<div class="fallback-content"><p>åœ–è¡¨æš«æ™‚ç„¡æ³•è¼‰å…¥</p><button onclick="location.reload()">é‡æ–°è¼‰å…¥</button></div>';
          });
        }
      }, 10000);

      window.addEventListener("load", () => clearTimeout(tvTimeout));
    </script>

    <!-- TradingView è…³æœ¬ -->
    <script
      defer
      src="https://s3.tradingview.com/tv.js"
      onerror="document.querySelectorAll('[id^=tradingview_]').forEach(el => el.innerHTML='<div class=fallback-content><p>åœ–è¡¨è¼‰å…¥å¤±æ•—</p><button onclick=location.reload()>é‡æ–°è¼‰å…¥</button></div>')"
    ></script>
    <script defer src="../chart-config.js"></script>
  </head>
  <body>
    <script>
      // ========== ç”Ÿæˆé é¢å…§å®¹ ==========
      if (!SYMBOL) {
        // æ²’æœ‰è‚¡ç¥¨ä»£ç¢¼ï¼Œé¡¯ç¤ºé¸æ“‡é é¢ï¼ˆå…ˆé¡¯ç¤ºè¼‰å…¥ä¸­ï¼Œç„¶å¾Œæª¢æŸ¥ iconsï¼‰
        document.write(`
          <div id="stock-selector" style="padding: 40px; text-align: center; color: #fff; font-family: Arial;">
            <h1>ğŸ“ˆ Stock Watch</h1>
            <p>æ­£åœ¨è¼‰å…¥è‚¡ç¥¨åˆ—è¡¨...</p>
            <div style="margin-top: 20px;">
              <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #2a2e39; border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            </div>
            <style>
              @keyframes spin {
                to { transform: rotate(360deg); }
              }
            </style>
          </div>
        `);

        // ç•°æ­¥æª¢æŸ¥ icons ä¸¦æ›´æ–°é é¢
        (async function() {
          // ç²å– icon URLï¼ˆå„ªå…ˆ CDNï¼Œå‚™æ´æœ¬åœ°ï¼‰
          function getIconUrl(symbol) {
            const symbolLower = symbol.toLowerCase();
            const symbolUpper = symbol.toUpperCase();

            // è¿”å›å¤šé‡å‚™æ´ URL
            return {
              stocktwits: `https://logos.stocktwits-cdn.com/${symbolUpper}.png`,
              etoro: `https://etoro-cdn.etorostatic.com/market-avatars/${symbolLower}/150x150.png`,
              localSvg: `../icons/${symbolLower}.svg`,
              localPng: `../icons/${symbolLower}.png`
            };
          }

          // æª¢æŸ¥ icon æ˜¯å¦å¯ç”¨ï¼ˆä¿¡ä»» StockTwits CDNï¼Œåªæª¢æŸ¥æœ¬åœ°ä½”ä½ç¬¦ï¼‰
          async function checkIconExists(symbol) {
            const urls = getIconUrl(symbol);

            // 1. ç›´æ¥ä¿¡ä»» StockTwits CDNï¼ˆä¸æª¢æŸ¥ï¼Œè®“ç€è¦½å™¨è‡ªç„¶ fallbackï¼‰
            // æª¢æŸ¥æœ¬åœ°æ˜¯å¦æœ‰ä½”ä½ç¬¦ï¼ˆç”¨æ–¼é¡¯ç¤ºç‹€æ…‹ï¼‰
            let isPlaceholder = false;
            try {
              const svgResponse = await fetch(urls.localSvg);
              if (svgResponse.ok) {
                const svgText = await svgResponse.text();
                const size = svgText.length;
                isPlaceholder = (
                  size < 350 &&
                  svgText.includes('#1a1a1a') &&
                  svgText.includes('<text') &&
                  svgText.includes(symbol.toUpperCase())
                );
              }
            } catch (e) {}

            return { exists: true, url: urls.stocktwits, source: 'cdn', isPlaceholder };
          }

          // æª¢æŸ¥æ‰€æœ‰è‚¡ç¥¨
          const stocksWithStatus = await Promise.all(
            Object.keys(stockDatabase).sort().map(async (s) => ({
              symbol: s,
              name: stockDatabase[s].name,
              iconStatus: await checkIconExists(s)
            }))
          );

          const withIcons = stocksWithStatus.filter(s => s.iconStatus.exists && !s.iconStatus.isPlaceholder);
          const withPlaceholders = stocksWithStatus.filter(s => s.iconStatus.exists && s.iconStatus.isPlaceholder);
          const withoutIcons = stocksWithStatus.filter(s => !s.iconStatus.exists);

          // æ›´æ–°é é¢
          document.getElementById('stock-selector').innerHTML = `
            <h1>ğŸ“ˆ Stock Watch</h1>
            <p>è«‹é¸æ“‡è‚¡ç¥¨ä»£ç¢¼æˆ–ä½¿ç”¨ URLï¼š<code style="background: #2a2e39; padding: 5px 10px; border-radius: 3px;">?symbol=TSM</code></p>

            ${withIcons.length > 0 ? `
              <div style="margin-top: 30px;">
                <h3>âœ… å¯ç”¨è‚¡ç¥¨ï¼ˆ${withIcons.length}ï¼‰</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 15px;">
                  ${withIcons.map(s =>
                    `<a href="?symbol=${s.symbol}" title="${s.name} (${s.iconStatus.source === 'cdn' ? 'CDN' : 'æœ¬åœ°'})" style="background: #2a2e39; padding: 8px 15px; border-radius: 5px; text-decoration: none; color: #fff; display: inline-flex; align-items: center; gap: 8px; transition: background 0.2s;" onmouseover="this.style.background='#3a3e49'" onmouseout="this.style.background='#2a2e39'">
                      <img src="${s.iconStatus.url}" width="20" height="20" style="border-radius: 3px;" onerror="if(this.src.includes('stocktwits')){this.src='https://etoro-cdn.etorostatic.com/market-avatars/${s.symbol.toLowerCase()}/150x150.png'}else if(this.src.includes('etoro')){this.src='../icons/${s.symbol.toLowerCase()}.svg'}else if(this.src.includes('.svg')){this.src='../icons/${s.symbol.toLowerCase()}.png'}else{this.style.display='none'}">
                      ${s.symbol}
                    </a>`
                  ).join('')}
                </div>
              </div>
            ` : ''}

            ${withPlaceholders.length > 0 ? `
              <div style="margin-top: 30px; opacity: 0.7;">
                <h3>âš ï¸ ä½¿ç”¨ä½”ä½ç¬¦ Iconï¼ˆ${withPlaceholders.length}ï¼‰</h3>
                <p style="font-size: 14px; color: #888;">é€™äº›è‚¡ç¥¨çš„ Icon ä¸‹è¼‰å¤±æ•—ï¼Œä½¿ç”¨é è¨­ä½”ä½ç¬¦</p>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 15px;">
                  ${withPlaceholders.map(s =>
                    `<a href="?symbol=${s.symbol}" title="${s.name}" style="background: #3a3e49; padding: 8px 15px; border-radius: 5px; text-decoration: none; color: #aaa;">${s.symbol}</a>`
                  ).join('')}
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 10px; font-family: monospace;">node generate-stock.js ${withPlaceholders.map(s => s.symbol).join(',')}</p>
              </div>
            ` : ''}

            ${withoutIcons.length > 0 ? `
              <div style="margin-top: 30px; opacity: 0.5;">
                <h3>âŒ ç¼ºå°‘ Iconï¼ˆ${withoutIcons.length}ï¼‰</h3>
                <p style="font-size: 14px; color: #888;">éœ€è¦å…ˆç”Ÿæˆ Icon æ‰èƒ½ä½¿ç”¨</p>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 15px;">
                  ${withoutIcons.map(s =>
                    `<span title="${s.name}" style="background: #2a2e39; padding: 8px 15px; border-radius: 5px; color: #666; cursor: not-allowed;">${s.symbol}</span>`
                  ).join('')}
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 10px; font-family: monospace;">node generate-stock.js ${withoutIcons.map(s => s.symbol).join(',')}</p>
              </div>
            ` : ''}
          `;
        })();
      } else {
        // æœ‰è‚¡ç¥¨ä»£ç¢¼ï¼Œç”Ÿæˆåœ–è¡¨å®¹å™¨
        document.title = `${SYMBOL} Stock Technical Analysis`;

        // è¨­ç½® favicon - å„ªå…ˆä½¿ç”¨ StockTwits CDN
        const favicon = document.getElementById('favicon');

        // 1. å˜—è©¦ StockTwits CDN
        favicon.href = `https://logos.stocktwits-cdn.com/${SYMBOL}.png`;

        // 2. å¤±æ•—å‰‡å˜—è©¦ eToro CDN
        const img = new Image();
        img.onerror = () => {
          favicon.href = `https://etoro-cdn.etorostatic.com/market-avatars/${SYMBOL_LOWER}/150x150.png`;
          // 3. å¤±æ•—å‰‡å˜—è©¦æœ¬åœ° SVG
          const img2 = new Image();
          img2.onerror = () => {
            favicon.href = `../icons/${SYMBOL_LOWER}.svg`;
            // 4. æœ¬åœ° SVG å¤±æ•—å‰‡å˜—è©¦æœ¬åœ° PNG
            const img3 = new Image();
            img3.onerror = () => { favicon.href = `../icons/${SYMBOL_LOWER}.png`; };
            img3.src = favicon.href;
          };
          img2.src = favicon.href;
        };
        img.src = favicon.href;

        // ç”Ÿæˆåœ–è¡¨å®¹å™¨ HTML
        document.write(`
          <div class="charts-grid-3x4" data-symbol="${STOCK_INFO.exchange}:${SYMBOL}" data-prefix="${SYMBOL_LOWER}">
            <!-- ç¬¬ä¸€è¡Œ - 1å°æ™‚ -->
            <div id="tradingview_${SYMBOL_LOWER}_1h_col1"><div class="loading-placeholder"></div></div>
            <div id="tradingview_${SYMBOL_LOWER}_1h_col2"><div class="loading-placeholder"></div></div>
            <div id="tradingview_${SYMBOL_LOWER}_1h_col3"><div class="loading-placeholder"></div></div>
            <div id="tradingview_${SYMBOL_LOWER}_1h_col4"><div class="loading-placeholder"></div></div>

            <!-- ç¬¬äºŒè¡Œ - 4å°æ™‚ -->
            <div id="tradingview_${SYMBOL_LOWER}_4h_col1"><div class="loading-placeholder"></div></div>
            <div id="tradingview_${SYMBOL_LOWER}_4h_col2"><div class="loading-placeholder"></div></div>
            <div id="tradingview_${SYMBOL_LOWER}_4h_col3"><div class="loading-placeholder"></div></div>
            <div id="tradingview_${SYMBOL_LOWER}_4h_col4"><div class="loading-placeholder"></div></div>

            <!-- ç¬¬ä¸‰è¡Œ - 1å¤© -->
            <div id="tradingview_${SYMBOL_LOWER}_1d_col1"><div class="loading-placeholder"></div></div>
            <div id="tradingview_${SYMBOL_LOWER}_1d_col2"><div class="loading-placeholder"></div></div>
            <div id="tradingview_${SYMBOL_LOWER}_1d_col3"><div class="loading-placeholder"></div></div>
            <div id="tradingview_${SYMBOL_LOWER}_1d_col4"><div class="loading-placeholder"></div></div>
          </div>
        `);

        console.log(`âœ… å·²ç”Ÿæˆåœ–è¡¨å®¹å™¨: ${STOCK_INFO.exchange}:${SYMBOL}`);
      }
    </script>
  </body>
</html>
