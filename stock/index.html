<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="page-title">Stock Technical Analysis</title>
    <link rel="icon" type="image/png" id="favicon" href="../icons/default.png">
    <link rel="stylesheet" href="../styles.css" />

    <!-- è¼‰å…¥è‚¡ç¥¨è³‡æ–™åº« -->
    <script src="../stock-database.js"></script>

    <script>
      // stockDatabase å·²å¾ stock-database.js è¼‰å…¥

      // ========== æ ¸å¿ƒå‡½æ•¸ ==========
      function getSymbolFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        // ä½¿ç”¨ 's' åƒæ•¸ï¼Œé¿å… TradingView è‡ªå‹•è®€å– 'symbol' åƒæ•¸è¦†è“‹äº¤æ˜“æ‰€è¨­å®š
        return urlParams.get('s')?.toUpperCase() || null;
      }

      function getStockInfo(symbol) {
        return stockDatabase[symbol] || {
          exchange: 'NASDAQ',
          name: `${symbol} Corporation`
        };
      }

      // ========== åœ¨ HTML è¼‰å…¥å‰å…ˆå–å¾—è‚¡ç¥¨ä»£ç¢¼ä¸¦ç”Ÿæˆ HTML ==========
      const SYMBOL = getSymbolFromUrl();
      const SYMBOL_LOWER = SYMBOL ? SYMBOL.toLowerCase() : '';
      const STOCK_INFO = SYMBOL ? getStockInfo(SYMBOL) : null;

      console.log('ğŸ¯ å‹•æ…‹è¼‰å…¥è‚¡ç¥¨:', SYMBOL, STOCK_INFO);

      // è¼‰å…¥è¶…æ™‚æª¢æŸ¥
      let tvTimeout = setTimeout(() => {
        if (typeof TradingView === "undefined") {
          document.querySelectorAll('[id^="tradingview_"]').forEach((el) => {
            el.innerHTML = '<div class="fallback-content"><p>åœ–è¡¨æš«æ™‚ç„¡æ³•è¼‰å…¥</p><button onclick="location.reload()">é‡æ–°è¼‰å…¥</button></div>';
          });
        }
      }, 10000);

      window.addEventListener("load", () => clearTimeout(tvTimeout));
    </script>

    <!-- TradingView è…³æœ¬ -->
    <script
      defer
      src="https://s3.tradingview.com/tv.js"
      onerror="document.querySelectorAll('[id^=tradingview_]').forEach(el => el.innerHTML='<div class=fallback-content><p>åœ–è¡¨è¼‰å…¥å¤±æ•—</p><button onclick=location.reload()>é‡æ–°è¼‰å…¥</button></div>')"
    ></script>
    <script defer src="../chart-config.js"></script>
  </head>
  <body>
    <script>
      // ========== ç”Ÿæˆé é¢å…§å®¹ ==========
      if (!SYMBOL) {
        // æ²’æœ‰è‚¡ç¥¨ä»£ç¢¼ï¼Œé¡¯ç¤ºé¸æ“‡é é¢ï¼ˆå…ˆé¡¯ç¤ºè¼‰å…¥ä¸­ï¼Œç„¶å¾Œæª¢æŸ¥ iconsï¼‰
        document.write(`
          <div id="stock-selector" style="padding: 40px; text-align: center; color: #fff; font-family: Arial;">
            <h1>ğŸ“ˆ Stock Watch</h1>
            <p>æ­£åœ¨è¼‰å…¥è‚¡ç¥¨åˆ—è¡¨...</p>
            <div style="margin-top: 20px;">
              <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #2a2e39; border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            </div>
            <style>
              @keyframes spin {
                to { transform: rotate(360deg); }
              }
            </style>
          </div>
        `);

        // ç”Ÿæˆè‚¡ç¥¨åˆ—è¡¨é é¢
        (function() {
          // ç²å– icon URL
          function getIconUrl(symbol) {
            return `https://logos.stocktwits-cdn.com/${symbol.toUpperCase()}.png`;
          }

          // ç”Ÿæˆè‚¡ç¥¨é€£çµ HTMLï¼ˆå¸¶å¤šé‡ fallbackï¼‰
          function createStockLink(symbol, name) {
            const iconUrl = getIconUrl(symbol);
            const symbolLower = symbol.toLowerCase();
            // fallback: StockTwits -> eToro -> æœ¬åœ° svg -> æœ¬åœ° png -> éš±è—
            const fallback = `onerror="if(this.src.includes('stocktwits')){this.src='https://etoro-cdn.etorostatic.com/market-avatars/${symbolLower}/150x150.png'}else if(this.src.includes('etoro')){this.src='../icons/${symbolLower}.svg'}else if(this.src.includes('.svg')){this.src='../icons/${symbolLower}.png'}else{this.style.display='none'}"`;
            return `<a href="?s=${symbol}" title="${name}" class="stock-link">
              <img src="${iconUrl}" width="18" height="18" ${fallback}>
              <span>${symbol}</span>
            </a>`;
          }

          // ç”Ÿæˆé¡åˆ¥å€å¡Š HTML
          function createCategory(title, stocks) {
            if (!stocks || stocks.length === 0) return '';
            return `
              <div class="category">
                <h4>${title}</h4>
                <div class="stock-grid">
                  ${stocks.map(s => createStockLink(s.symbol, s.name)).join('')}
                </div>
              </div>
            `;
          }

          // æŒ‰äº¤æ˜“æ‰€å’Œé¡åˆ¥åˆ†çµ„è‚¡ç¥¨
          const nyseStocks = {};
          const nasdaqStocks = {};
          const amexStocks = [];

          // é¡åˆ¥å®šç¾©
          const categories = {
            'é‡‘è': ['BRK.B','JPM','V','MA','BAC','WFC','GS','MS','C','SCHW','BLK','AXP','COF','PNC','USB','TFC','BK','BX','KKR','ICE','SPGI','MCO','MMC','AON','AJG','CB','PGR','ALL','AFL','TRV'],
            'ç§‘æŠ€': ['ORCL','IBM','CRM','NOW','ACN','UBER','SNOW','PLTR','RBLX','NET','ANET','APH','TEL','GLW','MSI'],
            'é†«ç™‚': ['LLY','ABBV','TMO','DHR','ABT','BSX','PFE','BMY','ZTS','JNJ','MRK','SYK','MDT','BDX','CI','ELV','UNH','HCA','CVS','MCK','COR'],
            'é›¶å”®æ¶ˆè²»': ['HD','TJX','AZO','LOW','KR','TGT','DG','MCD','DIS','RCL','HLT','CMG','LYV','YUM','CCL','LVS','NKE','TKO'],
            'å·¥æ¥­': ['CAT','DE','MMM','ITW','JCI','GEV','GE','PH','CMI','ETN','TT','AME','ROK','XYL','WAB','CARR','EMR','ECL','SHW','APD','CRH'],
            'èˆªå¤ªåœ‹é˜²': ['BA','RTX','LMT','NOC','GD','LHX','TDG','HWM'],
            'èƒ½æº': ['XOM','CVX','COP','EOG','PSX','MPC','WMB','KMI','FCX','NEM'],
            'å…¬ç”¨äº‹æ¥­': ['NEE','DUK','SO','SRE','VST'],
            'ä¸å‹•ç”¢': ['PLD','AMT','WELL','SPG','DLR','O'],
            'äº¤é€šé‹è¼¸': ['UNP','NSC','UPS','FDX','URI','PWR'],
            'æ¶ˆè²»å“': ['PG','KO','PM','MO','CL','GM','F','WM'],
            'é›»ä¿¡': ['T','VZ'],
            'åœ‹éš›': ['TSM','BABA','NIO','XPEV']
          };

          const nasdaqCategories = {
            'ç§‘æŠ€å·¨é ­': ['NVDA','MSFT','AAPL','AMZN','GOOGL','GOOG','META','TSLA','AVGO','NFLX'],
            'åŠå°é«”': ['AMD','INTC','QCOM','MU','AMAT','LRCX','KLAC','ADI','TXN','MRVL'],
            'è»Ÿé«”æœå‹™': ['ADBE','INTU','PANW','CRWD','FTNT','ADSK','CDNS','SNPS','CSCO','ADP','FISV','PYPL'],
            'é›»å•†ç¶²è·¯': ['BKNG','ABNB','EBAY','EXPE','DASH','CPRT'],
            'é›¶å”®': ['WMT','COST','ORLY','ROST'],
            'é†«ç™‚': ['ISRG','AMGN','REGN','GILD','VRTX','IDXX','ALNY'],
            'æ¶ˆè²»åª’é«”': ['SBUX','MAR','CMCSA','CHTR','FOX','FOXA','WBD','EA'],
            'å·¥æ¥­': ['PCAR','CTAS','FAST','CSX','HON','LIN'],
            'é‡‘èç§‘æŠ€': ['COIN','HOOD','MSTR'],
            'å…¶ä»–': ['TMUS','PEP','MDLZ','AEP','CEG','EQIX','APP','CME']
          };

          // åˆ†é¡è‚¡ç¥¨
          Object.entries(stockDatabase).forEach(([symbol, info]) => {
            const stock = { symbol, name: info.name, exchange: info.exchange };
            if (info.exchange === 'NYSE') {
              for (const [cat, symbols] of Object.entries(categories)) {
                if (symbols.includes(symbol)) {
                  if (!nyseStocks[cat]) nyseStocks[cat] = [];
                  nyseStocks[cat].push(stock);
                  break;
                }
              }
            } else if (info.exchange === 'NASDAQ') {
              for (const [cat, symbols] of Object.entries(nasdaqCategories)) {
                if (symbols.includes(symbol)) {
                  if (!nasdaqStocks[cat]) nasdaqStocks[cat] = [];
                  nasdaqStocks[cat].push(stock);
                  break;
                }
              }
            } else if (info.exchange === 'AMEX') {
              amexStocks.push(stock);
            }
          });

          const nyseCount = Object.values(nyseStocks).flat().length;
          const nasdaqCount = Object.values(nasdaqStocks).flat().length;

          // æ›´æ–°é é¢
          document.getElementById('stock-selector').innerHTML = `
            <style>
              .stock-selector-container { padding: 20px 40px; color: #fff; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; max-width: 1600px; margin: 0 auto; }
              .stock-selector-container h1 { text-align: center; margin-bottom: 10px; }
              .stock-selector-container > p { text-align: center; color: #888; margin-bottom: 30px; }
              .stock-selector-container code { background: #2a2e39; padding: 4px 8px; border-radius: 4px; font-size: 14px; }
              .exchange-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
              .exchange-column { background: #1a1a1a; border-radius: 12px; padding: 20px; }
              .exchange-column h2 { margin: 0 0 20px 0; padding-bottom: 10px; border-bottom: 2px solid #333; font-size: 18px; }
              .exchange-column h2 .count { font-weight: normal; color: #666; font-size: 14px; }
              .nyse-column h2 { color: #4a9eff; border-color: #4a9eff; }
              .nasdaq-column h2 { color: #00c853; border-color: #00c853; }
              .category { margin-bottom: 20px; }
              .category h4 { margin: 0 0 10px 0; color: #888; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
              .stock-grid { display: flex; flex-wrap: wrap; gap: 6px; }
              .stock-link { display: inline-flex; align-items: center; gap: 6px; background: #2a2e39; padding: 6px 12px; border-radius: 6px; text-decoration: none; color: #fff; font-size: 13px; transition: all 0.15s; }
              .stock-link:hover { background: #3a4a5a; transform: translateY(-1px); }
              .stock-link img { border-radius: 3px; }
              .etf-section { margin-top: 30px; text-align: center; }
              .etf-section h3 { color: #ff9800; margin-bottom: 15px; font-size: 16px; }
              .etf-grid { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
              @media (max-width: 900px) { .exchange-columns { grid-template-columns: 1fr; } }
            </style>

            <h1>Stock Watch</h1>
            <p>é¸æ“‡è‚¡ç¥¨æˆ–ä½¿ç”¨ URL <code>?s=NVDA</code></p>

            <div class="exchange-columns">
              <div class="exchange-column nyse-column">
                <h2>NYSE <span class="count">(${nyseCount})</span></h2>
                ${Object.entries(nyseStocks).map(([cat, stocks]) => createCategory(cat, stocks)).join('')}
              </div>
              <div class="exchange-column nasdaq-column">
                <h2>NASDAQ <span class="count">(${nasdaqCount})</span></h2>
                ${Object.entries(nasdaqStocks).map(([cat, stocks]) => createCategory(cat, stocks)).join('')}
              </div>
            </div>

            ${amexStocks.length > 0 ? `
              <div class="etf-section">
                <h3>AMEX ETF (${amexStocks.length})</h3>
                <div class="etf-grid">
                  ${amexStocks.map(s => createStockLink(s.symbol, s.name)).join('')}
                </div>
              </div>
            ` : ''}
          `;
        })();
      } else {
        // æœ‰è‚¡ç¥¨ä»£ç¢¼ï¼Œç”Ÿæˆåœ–è¡¨å®¹å™¨
        document.title = `${SYMBOL} Stock Technical Analysis`;

        // è¨­ç½® favicon - å„ªå…ˆä½¿ç”¨ StockTwits CDN
        const favicon = document.getElementById('favicon');

        // 1. å˜—è©¦ StockTwits CDN
        favicon.href = `https://logos.stocktwits-cdn.com/${SYMBOL}.png`;

        // 2. å¤±æ•—å‰‡å˜—è©¦ eToro CDN
        const img = new Image();
        img.onerror = () => {
          favicon.href = `https://etoro-cdn.etorostatic.com/market-avatars/${SYMBOL_LOWER}/150x150.png`;
          // 3. å¤±æ•—å‰‡å˜—è©¦æœ¬åœ° SVG
          const img2 = new Image();
          img2.onerror = () => {
            favicon.href = `../icons/${SYMBOL_LOWER}.svg`;
            // 4. æœ¬åœ° SVG å¤±æ•—å‰‡å˜—è©¦æœ¬åœ° PNG
            const img3 = new Image();
            img3.onerror = () => { favicon.href = `../icons/${SYMBOL_LOWER}.png`; };
            img3.src = favicon.href;
          };
          img2.src = favicon.href;
        };
        img.src = favicon.href;

        // ç”Ÿæˆåœ–è¡¨å®¹å™¨ HTML
        document.write(`
          <div class="charts-grid-3x4" data-symbol="${STOCK_INFO.exchange}:${SYMBOL}" data-prefix="${SYMBOL_LOWER}">
            <!-- ç¬¬ä¸€è¡Œ - 1å°æ™‚ -->
            <div id="tradingview_${SYMBOL_LOWER}_1h_col1"><div class="loading-placeholder"></div></div>
            <div id="tradingview_${SYMBOL_LOWER}_1h_col2"><div class="loading-placeholder"></div></div>
            <div id="tradingview_${SYMBOL_LOWER}_1h_col3"><div class="loading-placeholder"></div></div>
            <div id="tradingview_${SYMBOL_LOWER}_1h_col4"><div class="loading-placeholder"></div></div>

            <!-- ç¬¬äºŒè¡Œ - 4å°æ™‚ -->
            <div id="tradingview_${SYMBOL_LOWER}_4h_col1"><div class="loading-placeholder"></div></div>
            <div id="tradingview_${SYMBOL_LOWER}_4h_col2"><div class="loading-placeholder"></div></div>
            <div id="tradingview_${SYMBOL_LOWER}_4h_col3"><div class="loading-placeholder"></div></div>
            <div id="tradingview_${SYMBOL_LOWER}_4h_col4"><div class="loading-placeholder"></div></div>

            <!-- ç¬¬ä¸‰è¡Œ - 1å¤© -->
            <div id="tradingview_${SYMBOL_LOWER}_1d_col1"><div class="loading-placeholder"></div></div>
            <div id="tradingview_${SYMBOL_LOWER}_1d_col2"><div class="loading-placeholder"></div></div>
            <div id="tradingview_${SYMBOL_LOWER}_1d_col3"><div class="loading-placeholder"></div></div>
            <div id="tradingview_${SYMBOL_LOWER}_1d_col4"><div class="loading-placeholder"></div></div>
          </div>
        `);

        console.log(`âœ… å·²ç”Ÿæˆåœ–è¡¨å®¹å™¨: ${STOCK_INFO.exchange}:${SYMBOL}`);

        // ========== éµç›¤å¿«æ·éµ ==========
        document.addEventListener('keydown', (e) => {
          // Shift + M: é–‹å•Ÿ MoneyDJ è‚¡ç¥¨ä»‹ç´¹é é¢
          if (e.shiftKey && e.key.toUpperCase() === 'M') {
            e.preventDefault();
            const moneydjUrl = `https://www.moneydj.com/us/basic/basic0001/${SYMBOL}`;
            window.open(moneydjUrl, '_blank');
            console.log(`ğŸ”— é–‹å•Ÿ MoneyDJ: ${moneydjUrl}`);
          }
        });
      }
    </script>
  </body>
</html>
